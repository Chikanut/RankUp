<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuizForge - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="app">
    
    <!-- Header -->
    <header class="stats-header">
      <button class="btn-back" onclick="window.location.href='index.html'">
        ‚Üê –ù–∞–∑–∞–¥ –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É
      </button>
      <div>
        <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
        <p class="muted">–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å —Ç–∞ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è</p>
      </div>
    </header>
    
    <!-- –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <section class="global-stats" id="globalStats">
      <!-- –ì–µ–Ω–µ—Ä—É—î—Ç—å—Å—è JS -->
    </section>
    
    <!-- –°–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç—ñ–≤ –∑ —ñ—Å—Ç–æ—Ä—ñ—î—é -->
    <section class="tests-stats" id="testsStats">
      <h2>üìö –¢–µ—Å—Ç–∏ –∑ —ñ—Å—Ç–æ—Ä—ñ—î—é</h2>
      <div id="testsStatsList">
        <!-- –ì–µ–Ω–µ—Ä—É—î—Ç—å—Å—è JS -->
      </div>
    </section>
    
    <!-- –î–µ—Ç–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –ø—Ä–∏ –∫–ª—ñ–∫—É) -->
    <section class="detailed-stats hidden" id="detailedStats">
      <!-- –ì–µ–Ω–µ—Ä—É—î—Ç—å—Å—è JS -->
    </section>
    
  </div>
  
  <!-- Loading screen -->
  <div id="loading" class="loading-screen">
    <div class="loading-spinner"></div>
    <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
  </div>
  
  <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–∫—Ä–∏–ø—Ç—ñ–≤ -->
  <script type="module">
    import analytics from './js/analytics.js';
    
    let masterConfig = null;
    let currentDetailedTest = null;
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é —Ç–µ—Å—Ç—ñ–≤
    async function loadConfig() {
      const response = await fetch('data/tests.json');
      masterConfig = await response.json();
    }
    
    // –ó–Ω–∞–π—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Ç–µ—Å—Ç
    function getTestInfo(testId) {
      if (!masterConfig) return null;
      return masterConfig.tests.find(t => t.id === testId);
    }
    
    // –†–µ–Ω–¥–µ—Ä –∑–∞–≥–∞–ª—å–Ω–æ—ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function renderGlobalStats() {
      const stats = analytics.getGlobalStats();
      const container = document.getElementById('globalStats');
      
      if (stats.totalTests === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìä</div>
            <h3>–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h3>
            <p class="muted">–ü—Ä–æ–π–¥—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω —Ç–µ—Å—Ç —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–≤—ñ–π –ø—Ä–æ–≥—Ä–µ—Å</p>
            <button class="btn-primary" onclick="window.location.href='index.html'">
              –ü–µ—Ä–µ–π—Ç–∏ –¥–æ —Ç–µ—Å—Ç—ñ–≤
            </button>
          </div>
        `;
        return;
      }
      
      const hours = Math.floor(stats.totalTimeSpent / 3600);
      const minutes = Math.floor((stats.totalTimeSpent % 3600) / 60);
      const timeText = hours > 0 
        ? `${hours}–≥ ${minutes}—Ö–≤` 
        : `${minutes}—Ö–≤`;
      
      container.innerHTML = `
        <h2>üìà –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">üìö</div>
            <div class="stat-value">${stats.totalTests}</div>
            <div class="stat-label">–¢–µ—Å—Ç—ñ–≤ –∑ —ñ—Å—Ç–æ—Ä—ñ—î—é</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">üîÑ</div>
            <div class="stat-value">${stats.totalAttempts}</div>
            <div class="stat-label">–í—Å—å–æ–≥–æ —Å–ø—Ä–æ–±</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">üìù</div>
            <div class="stat-value">${stats.totalQuestions}</div>
            <div class="stat-label">–ü–∏—Ç–∞–Ω—å –ø—Ä–æ–π–¥–µ–Ω–æ</div>
          </div>
          
          <div class="stat-card ${stats.averagePercentage >= 70 ? 'success' : ''}">
            <div class="stat-icon">‚ú®</div>
            <div class="stat-value">${stats.averagePercentage}%</div>
            <div class="stat-label">–°–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-value">${stats.totalCorrect}</div>
            <div class="stat-label">–ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">‚è±Ô∏è</div>
            <div class="stat-value">${timeText}</div>
            <div class="stat-label">–í–∏—Ç—Ä–∞—á–µ–Ω–æ —á–∞—Å—É</div>
          </div>
        </div>
      `;
    }
    
    // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫—É —Ç–µ—Å—Ç—ñ–≤
    function renderTestsList() {
      const globalStats = analytics.getGlobalStats();
      const container = document.getElementById('testsStatsList');
      
      if (globalStats.testsWithHistory.length === 0) {
        container.innerHTML = '<p class="muted">–ù–µ–º–∞—î —Ç–µ—Å—Ç—ñ–≤ –∑ —ñ—Å—Ç–æ—Ä—ñ—î—é</p>';
        return;
      }
      
      container.innerHTML = globalStats.testsWithHistory.map(test => {
        const testInfo = getTestInfo(test.testId);
        const stats = analytics.getTestStats(test.testId);
        
        const title = testInfo?.title || test.testId;
        const icon = testInfo?.icon || 'üìù';
        
        return `
          <div class="test-stat-card" data-test-id="${test.testId}">
            <div class="test-stat-header">
              <div class="test-stat-icon">${icon}</div>
              <div class="test-stat-info">
                <h3>${title}</h3>
                <div class="test-stat-meta">
                  <span class="badge">–°–ø—Ä–æ–±: ${stats.attempts}</span>
                  <span class="badge">–°–µ—Ä–µ–¥–Ω—ñ–π: ${stats.averageScore}%</span>
                  <span class="badge ${stats.improvement >= 0 ? 'badge-success' : 'badge-error'}">
                    ${stats.improvement >= 0 ? '‚Üó' : '‚Üò'} ${Math.abs(stats.improvement)}%
                  </span>
                </div>
              </div>
            </div>
            
            <div class="progress-bar-large">
              <div class="progress-fill" style="width: ${stats.averageScore}%"></div>
              <span class="progress-text">${stats.averageScore}%</span>
            </div>
            
            <div class="test-stat-actions">
              <button class="btn-ghost btn-sm" onclick="viewDetails('${test.testId}')">
                üìä –î–µ—Ç–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
              </button>
              <button class="btn-ghost btn-sm" onclick="clearHistory('${test.testId}')">
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    window.viewDetails = function(testId) {
      currentDetailedTest = testId;
      const stats = analytics.getTestStats(testId);
      const testInfo = getTestInfo(testId);
      const container = document.getElementById('detailedStats');
      
      const title = testInfo?.title || testId;
      const icon = testInfo?.icon || 'üìù';
      
      // –ü—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞
      const chartData = analytics.prepareChartData(stats.history);
      
      container.innerHTML = `
        <div class="detailed-header">
          <button class="btn-back" onclick="closeDetails()">‚Üê –ù–∞–∑–∞–¥</button>
          <div>
            <h2>${icon} ${title}</h2>
            <p class="muted">–î–µ—Ç–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</p>
          </div>
        </div>
        
        <div class="detailed-content">
          <!-- –ö–ª—é—á–æ–≤—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value">${stats.attempts}</div>
              <div class="stat-label">–°–ø—Ä–æ–±</div>
            </div>
            <div class="stat-card success">
              <div class="stat-value">${stats.bestScore}%</div>
              <div class="stat-label">–ö—Ä–∞—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${stats.averageScore}%</div>
              <div class="stat-label">–°–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
            </div>
            <div class="stat-card ${stats.improvement >= 0 ? 'success' : ''}">
              <div class="stat-value">${stats.improvement >= 0 ? '+' : ''}${stats.improvement}%</div>
              <div class="stat-label">–ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è</div>
            </div>
          </div>
          
          <!-- –ì—Ä–∞—Ñ—ñ–∫ —ñ—Å—Ç–æ—Ä—ñ—ó -->
          <div class="chart-container">
            <h3>üìà –Ü—Å—Ç–æ—Ä—ñ—è –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω—å</h3>
            <canvas id="historyChart" width="800" height="250"></canvas>
          </div>
          
          <!-- –Ü—Å—Ç–æ—Ä—ñ—è —Å–ø—Ä–æ–± -->
          <div class="history-section">
            <h3>üìã –Ü—Å—Ç–æ—Ä—ñ—è —Å–ø—Ä–æ–±</h3>
            <div class="history-table">
              <table>
                <thead>
                  <tr>
                    <th>–î–∞—Ç–∞</th>
                    <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                    <th>–ü—Ä–∞–≤–∏–ª—å–Ω–æ</th>
                    <th>–ß–∞—Å</th>
                  </tr>
                </thead>
                <tbody>
                  ${stats.history.map(attempt => {
                    const date = new Date(attempt.date);
                    const dateStr = `${date.getDate()}.${date.getMonth() + 1}.${date.getFullYear()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                    const minutes = Math.floor(attempt.timeSpent / 60);
                    const seconds = attempt.timeSpent % 60;
                    
                    return `
                      <tr>
                        <td>${dateStr}</td>
                        <td><span class="badge ${attempt.percentage >= 70 ? 'badge-success' : ''}">${attempt.percentage}%</span></td>
                        <td>${attempt.score || attempt.correctCount} / ${attempt.total || attempt.totalQuestions}</td>
                        <td>${minutes}:${seconds.toString().padStart(2, '0')}</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- –ù–∞–π—Å–∫–ª–∞–¥–Ω—ñ—à—ñ –ø–∏—Ç–∞–Ω–Ω—è -->
          <div class="hardest-questions">
            <h3>üî• –ù–∞–π—Å–∫–ª–∞–¥–Ω—ñ—à—ñ –ø–∏—Ç–∞–Ω–Ω—è</h3>
            <p class="muted">–ü–∏—Ç–∞–Ω–Ω—è –≤ —è–∫–∏—Ö –≤–∏ –Ω–∞–π—á–∞—Å—Ç—ñ—à–µ –ø–æ–º–∏–ª—è—î—Ç–µ—Å—å</p>
            <div id="hardestQuestions">
              <!-- –ë—É–¥–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–∏—Ç–∞–Ω—å -->
            </div>
          </div>
        </div>
      `;
      
      // –ü–æ–∫–∞–∑–∞—Ç–∏ —Å–µ–∫—Ü—ñ—é
      container.classList.remove('hidden');
      container.scrollIntoView({ behavior: 'smooth' });
      
      // –ù–∞–º–∞–ª—é–≤–∞—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫
      drawChart(chartData);
      
      // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç–∞ –ø–æ–∫–∞–∑–∞—Ç–∏ –Ω–∞–π—Å–∫–ª–∞–¥–Ω—ñ—à—ñ –ø–∏—Ç–∞–Ω–Ω—è
      loadHardestQuestions(testId);
    };
    
    // –ó–∞–∫—Ä–∏—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    window.closeDetails = function() {
      document.getElementById('detailedStats').classList.add('hidden');
      currentDetailedTest = null;
    };
    
    // –ù–∞–º–∞–ª—é–≤–∞—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫
    function drawChart(data) {
      const canvas = document.getElementById('historyChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      const padding = 40;
      
      // –û—á–∏—Å—Ç–∏—Ç–∏ canvas
      ctx.clearRect(0, 0, width, height);
      
      if (data.labels.length === 0) {
        ctx.fillStyle = '#9ca3af';
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞', width / 2, height / 2);
        return;
      }
      
      // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
      const chartWidth = width - padding * 2;
      const chartHeight = height - padding * 2;
      const maxValue = 100;
      const stepX = chartWidth / (data.data.length - 1 || 1);
      
      // –§–æ–Ω —Ç–∞ —Å—ñ—Ç–∫–∞
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
      ctx.lineWidth = 1;
      
      // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ñ –ª—ñ–Ω—ñ—ó
      for (let i = 0; i <= 4; i++) {
        const y = padding + (chartHeight / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
        ctx.stroke();
        
        // –ü—ñ–¥–ø–∏—Å–∏
        ctx.fillStyle = '#9ca3af';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText(`${100 - i * 25}%`, padding - 10, y + 4);
      }
      
      // –ú–∞–ª—é–≤–∞–Ω–Ω—è –ª—ñ–Ω—ñ—ó –≥—Ä–∞—Ñ—ñ–∫–∞
      ctx.strokeStyle = '#3b82f6';
      ctx.lineWidth = 3;
      ctx.lineJoin = 'round';
      ctx.lineCap = 'round';
      
      ctx.beginPath();
      data.data.forEach((value, index) => {
        const x = padding + stepX * index;
        const y = padding + chartHeight - (value / maxValue) * chartHeight;
        
        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });
      ctx.stroke();
      
      // –¢–æ—á–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ—ñ–∫—É
      data.data.forEach((value, index) => {
        const x = padding + stepX * index;
        const y = padding + chartHeight - (value / maxValue) * chartHeight;
        
        // –¢–æ—á–∫–∞
        ctx.fillStyle = '#3b82f6';
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, Math.PI * 2);
        ctx.fill();
        
        // –û–±–≤–µ–¥–µ–Ω–Ω—è
        ctx.strokeStyle = '#0f1724';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        // –ü—ñ–¥–ø–∏—Å –¥–∞—Ç–∏
        ctx.fillStyle = '#9ca3af';
        ctx.font = '11px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(data.labels[index], x, height - 10);
      });
    }
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–∞–π—Å–∫–ª–∞–¥–Ω—ñ—à—ñ –ø–∏—Ç–∞–Ω–Ω—è
    async function loadHardestQuestions(testId) {
      const hardest = analytics.getHardestQuestions(testId, 10);
      const container = document.getElementById('hardestQuestions');
      
      if (hardest.length === 0) {
        container.innerHTML = '<p class="muted">–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö</p>';
        return;
      }
      
      // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è –∑ JSON
      try {
        const testInfo = getTestInfo(testId);
        if (!testInfo) {
          container.innerHTML = '<p class="muted">–ù–µ –≤–¥–∞–ª–æ—Å—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è</p>';
          return;
        }
        
        const response = await fetch(testInfo.dataFile);
        const testData = await response.json();
        
        container.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>–ü–∏—Ç–∞–Ω–Ω—è</th>
                <th>–°–ø—Ä–æ–±</th>
                <th>% –ø–æ–º–∏–ª–æ–∫</th>
              </tr>
            </thead>
            <tbody>
              ${hardest.map((item, index) => {
                const question = testData.questions.find(q => q.id === item.questionId);
                const questionText = question?.question || `–ü–∏—Ç–∞–Ω–Ω—è ${item.questionId}`;
                
                return `
                  <tr>
                    <td>${index + 1}</td>
                    <td class="question-text-cell">${questionText}</td>
                    <td>${item.attempts}</td>
                    <td><span class="badge badge-error">${item.errorRate}%</span></td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
      } catch (e) {
        console.error('Failed to load questions:', e);
        container.innerHTML = '<p class="muted">–ù–µ –≤–¥–∞–ª–æ—Å—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è</p>';
      }
    }
    
    // –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é —Ç–µ—Å—Ç—É
    window.clearHistory = function(testId) {
      const testInfo = getTestInfo(testId);
      const title = testInfo?.title || testId;
      
      if (!confirm(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ —â–æ —Ö–æ—á–µ—Ç–µ –æ—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é —Ç–µ—Å—Ç—É "${title}"?\n\n–¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏.`)) {
        return;
      }
      
      analytics.clearTestHistory(testId);
      
      // –û–Ω–æ–≤–∏—Ç–∏ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
      renderGlobalStats();
      renderTestsList();
      
      // –ó–∞–∫—Ä–∏—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —è–∫—â–æ –±—É–ª–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞
      if (currentDetailedTest === testId) {
        closeDetails();
      }
      
      alert('–Ü—Å—Ç–æ—Ä—ñ—é –æ—á–∏—â–µ–Ω–æ!');
    };
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        await loadConfig();
        renderGlobalStats();
        renderTestsList();
        
        document.getElementById('loading').style.display = 'none';
      } catch (error) {
        console.error('Failed to load stats:', error);
        document.getElementById('loading').innerHTML = `
          <div class="error-icon">‚ùå</div>
          <p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>
          <p class="muted">${error.message}</p>
        `;
      }
    });
  </script>
</body>
</html>
